x-odoo-common: &odoo-common
  image: rental-odoo
  build: .
  restart: always
  volumes:
    - rental-odoo-web-data:/var/lib/odoo
    - ./addons:/mnt/extra-addons
    - ./conf/odoo.conf.tmpl:/etc/odoo/odoo.conf.tmpl
  env_file:
    - .env
  depends_on:
    rental_odoo_db:
      condition: service_healthy
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "5"

networks:
  rental-net:
    external: true

volumes:
  rental-odoo-web-data:
  rental-odoo-db-data:

services:
  rental_odoo_db:
    container_name: rental_odoo_db
    image: postgres:16
    restart: always
    volumes:
      - rental-odoo-db-data:/var/lib/postgresql/data/pgdata
    env_file:
      - .env
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    networks:
      - rental-net
    healthcheck:
      test: ['CMD-SHELL', "pg_isready -U ${POSTGRES_USER} -d ${DB_NAME:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  rental_odoo:
    <<: *odoo-common
    container_name: rental_odoo
    command: ["odoo", "-u", "rental_vehicles", "--without-demo=all"]
    expose:
      - "${ODOO_HTTP_PORT:-8069}"
    networks:
      - rental-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${ODOO_HTTP_PORT:-8069}/web/login"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
